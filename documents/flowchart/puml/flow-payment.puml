@startuml 결제_실행_플로우
title 결제 실행 플로우

start

:결제 요청;

:주문 정보 확인;

if (주문이 존재하나?) then (아니오)
  #pink:결제 실패\n(주문 없음);
  stop
endif

if (주문 상태가 대기 중인가?) then (아니오)
  #pink:결제 실패\n(이미 처리된 주문);
  stop
endif

if (쿠폰을 사용하나?) then (예)
  :쿠폰 확인;

  if (쿠폰이 유효한가?) then (아니오)
    #pink:결제 실패\n(쿠폰 만료/사용됨);
    stop
  endif

  :할인 금액 계산;
  :쿠폰 사용 처리;
endif

:최종 결제 금액 계산;
:사용자 잔액 확인;

if (잔액이 충분한가?) then (아니오)
  :재고 복구;
  :주문 취소;
  #pink:결제 실패\n(잔액 부족);
  stop
endif

:잔액 차감;
:결제 내역 저장;
:주문 완료 처리;

:외부 데이터 플랫폼에\n주문 정보 전송 (비동기);
note right
  전송 실패해도
  결제는 완료됨
end note

#lightgreen:결제 완료;

stop

@enduml
